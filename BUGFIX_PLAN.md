# Deployment Bugfix Plan

## Problem Analysis

### Issue 1: Prisma Migration Error (P3005)
```
Error: P3005 - The database schema is not empty.
```
**Cause**: The Neon database already has tables/objects, but Prisma has no migration history in `prisma/migrations` folder.

### Issue 2: Port Binding Issue
```
No open ports detected, continuing to scan...
==> Exited with status 1
```
**Cause**: The server may not be binding to Railway's dynamic `$PORT` environment variable.

---

## Fix Plan

### Step 1: Create Prisma Baseline Migration
1. Create the `prisma/migrations` directory
2. Create an initial migration that baselines the existing database schema
3. Run `prisma migrate deploy` to sync without applying new migrations

### Step 2: Fix Port Binding in server.js
Update `src/server.js` to:
- Use `$PORT` environment variable (Railway's dynamic port)
- Fall back to 5000 for local development
- Ensure the server properly binds to 0.0.0.0 (not just localhost)

### Step 3: Update railway.json
Update the start command to:
- Generate Prisma client first
- Baseline the database if needed
- Start the server

### Step 4: Test Locally
Verify the fix works locally before redeploying

---

## Files to Modify

| File | Changes |
|------|---------|
| `marketplace-backend/prisma/migrations/` | Create initial migration folder and migration.sql |
| `marketplace-backend/src/server.js` | Fix port binding to use `$PORT` and `0.0.0.0` |
| `marketplace-backend/railway.json` | Update start command for baseline |

---

## Commands to Execute

```bash
# 1. Create baseline migration
cd marketplace-backend
mkdir -p prisma/migrations/00000000000000_init
cat > prisma/migrations/00000000000000_init/migration.sql << 'EOF'
-- CreateEnum
CREATE TYPE "Role" AS ENUM ('ADMIN', 'BUYER', 'SOLVER');

-- CreateEnum
CREATE TYPE "ProjectStatus" AS ENUM ('UNASSIGNED', 'ASSIGNED', 'COMPLETED', 'CANCELLED');

-- CreateEnum
CREATE TYPE "TaskStatus" AS ENUM ('IN_PROGRESS', 'SUBMITTED', 'COMPLETED');

-- CreateEnum
CREATE TYPE "RequestStatus" AS ENUM ('PENDING', 'ACCEPTED', 'REJECTED');

-- CreateTable
CREATE TABLE "User" (
    "id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "role" "Role" NOT NULL DEFAULT 'SOLVER',
    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Project" (
    "id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "status" "ProjectStatus" NOT NULL DEFAULT 'UNASSIGNED',
    "buyerId" TEXT NOT NULL,
    "assignedSolverId" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "Project_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Request" (
    "id" TEXT NOT NULL,
    "projectId" TEXT NOT NULL,
    "solverId" TEXT NOT NULL,
    "status" "RequestStatus" NOT NULL DEFAULT 'PENDING',
    CONSTRAINT "Request_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Task" (
    "id" TEXT NOT NULL,
    "projectId" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "deadline" TIMESTAMP(3) NOT NULL,
    "status" "TaskStatus" NOT NULL DEFAULT 'IN_PROGRESS',
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    CONSTRAINT "Task_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Submission" (
    "id" TEXT NOT NULL,
    "taskId" TEXT NOT NULL,
    "fileUrl" TEXT NOT NULL,
    "submittedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT "Submission_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

-- CreateIndex
CREATE UNIQUE INDEX "Submission_taskId_key" ON "Submission"("taskId");

-- AddForeignKey
ALTER TABLE "Project" ADD CONSTRAINT "Project_buyerId_fkey" FOREIGN KEY ("buyerId") REFERENCES "User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Project" ADD CONSTRAINT "Project_assignedSolverId_fkey" FOREIGN KEY ("assignedSolverId") REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Request" ADD CONSTRAINT "Request_projectId_fkey" FOREIGN KEY ("projectId") REFERENCES "Project"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Request" ADD CONSTRAINT "Request_solverId_fkey" FOREIGN KEY ("solverId") REFERENCES "User"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Task" ADD CONSTRAINT "Task_projectId_fkey" FOREIGN KEY ("projectId") REFERENCES "Project"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Submission" ADD CONSTRAINT "Submission_taskId_fkey" FOREIGN KEY ("taskId") REFERENCES "Task"("id") ON DELETE CASCADE ON UPDATE CASCADE;
EOF

# 2. Create migration_lock.toml
cat > prisma/migrations/migration_lock.toml << 'EOF'
# Please do not edit this file manually
# It should be added in version control
provider = "postgresql"
EOF

# 3. Generate Prisma client
npx prisma generate

# 4. Deploy migrations
npx prisma migrate deploy
```

---

## Implementation Status

- [ ] Step 1: Create baseline migration files
- [ ] Step 2: Fix port binding in server.js
- [ ] Step 3: Update railway.json
- [ ] Step 4: Test deployment

